#!/bin/bashset -euo pipefailtrap 'echo -e "\n‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ."; exit 1' ERR# ========== –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==========HYSTERIA_INSTALL_DIR="/etc/hysteria"HYSTERIA_VENV_DIR="$HYSTERIA_INSTALL_DIR/hysteria2_venv"# ‚úÖ RU GeoIP/GeoSite (IPv4) ‚Äî latest releaseGEOSITE_URL="https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geosite.dat"GEOIP_URL="https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geoip.dat"MIGRATE_SCRIPT_PATH="$HYSTERIA_INSTALL_DIR/core/scripts/db/migrate_users.py"# ========== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ ==========GREEN=$(tput setaf 2)RED=$(tput setaf 1)YELLOW=$(tput setaf 3)BLUE=$(tput setaf 4)RESET=$(tput sgr0)info() { echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')] [–ò–ù–§–û] - ${RESET} $1"; }success() { echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] [–û–ö] - ${RESET} $1"; }warn() { echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] [–í–ù–ò–ú–ê–ù–ò–ï] - ${RESET} $1"; }error() { echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] [–û–®–ò–ë–ö–ê] - ${RESET} $1"; }# ========== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ AVX ==========check_avx_support() {    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É AVX (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è MongoDB)..."    if grep -q -m1 -o -E 'avx|avx2|avx512' /proc/cpuinfo; then        success "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π AVX."    else        error "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π AVX –¥–ª—è MongoDB."        info "–í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å —ç—Ç–æ–π –≤–µ—Ä—Å–∏–µ–π."        info "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è 'nodb' (–±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö):"        echo -e "${YELLOW}bash <(curl -sL https://raw.githubusercontent.com/Asgaroth-SG/AsgarothGate/nodb/upgrade.sh)${RESET}"        error "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ."        exit 1    fi}# ========== –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Caddy ==========fix_caddy_repo() {    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Caddy..."    local caddy_source_list="/etc/apt/sources.list.d/caddy-stable.list"    local new_caddy_keyring="/usr/share/keyrings/caddy-stable-archive-keyring.gpg"    local old_caddy_key="/etc/apt/trusted.gpg.d/caddy.asc"    if [[ -f "$old_caddy_key" ]] || { [[ -f "$caddy_source_list" ]] && grep -q "caddy.asc" "$caddy_source_list"; }; then        warn "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Caddy. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º..."        if [[ -f "$old_caddy_key" ]]; then            rm -f "$old_caddy_key"            info "–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π GPG –∫–ª—é—á Caddy."        fi        rm -f "$new_caddy_keyring"        info "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ GPG –∫–ª—é—á–∞ Caddy..."        if ! curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o "$new_caddy_keyring"; then            error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å GPG –∫–ª—é—á Caddy."            exit 1        fi        info "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ Caddy..."        curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee "$caddy_source_list" > /dev/null        chmod o+r "$new_caddy_keyring"        chmod o+r "$caddy_source_list"        info "–ó–∞–ø—É—Å–∫ apt update –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."        apt-get update -qq        success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Caddy –æ–±–Ω–æ–≤–ª–µ–Ω–∞."    else        success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Caddy –∞–∫—Ç—É–∞–ª—å–Ω–∞."    fi}# ========== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MongoDB ==========install_mongodb() {    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è MongoDB..."    if ! command -v mongod &>/dev/null; then        warn "MongoDB –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."        local os_name os_version        os_name=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')        os_version=$(grep '^VERSION_ID=' /etc/os-release | cut -d= -f2 | tr -d '"')        apt-get update        apt-get install -y gnupg curl lsb-release        curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor        if [[ "$os_name" == "ubuntu" ]]; then            if [[ "$os_version" == "24.04" ]]; then                echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu noble/mongodb-org/8.0 multiverse" > /etc/apt/sources.list.d/mongodb-org-8.0.list            elif [[ "$os_version" == "22.04" ]]; then                echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" > /etc/apt/sources.list.d/mongodb-org-8.0.list            else                echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" > /etc/apt/sources.list.d/mongodb-org-8.0.list            fi        elif [[ "$os_name" == "debian" && "$os_version" == "12" ]]; then            echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] http://repo.mongodb.org/apt/debian bookworm/mongodb-org/8.0 main" > /etc/apt/sources.list.d/mongodb-org-8.0.list        else            error "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –û–° –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ MongoDB: $os_name $os_version"            exit 1        fi        apt-get update -qq        apt-get install -y mongodb-org        systemctl start mongod        systemctl enable mongod        success "MongoDB —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞."    else        success "MongoDB —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞."    fi}# ========== –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ==========migrate_json_to_mongo() {    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö..."    if [[ -f "$HYSTERIA_INSTALL_DIR/users.json" ]]; then        info "–ù–∞–π–¥–µ–Ω users.json. –ü—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ MongoDB."        if python3 "$MIGRATE_SCRIPT_PATH"; then            success "–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."        else            error "–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ."            exit 1        fi    else        info "users.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞."    fi}download_and_extract_latest_release() {    local arch    case $(uname -m) in        x86_64) arch="amd64" ;;        aarch64) arch="arm64" ;;        *)            error "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $(uname -m)"            exit 1            ;;    esac    info "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $arch"    local zip_name="AsgarothGate-${arch}.zip"    local download_url="https://github.com/Asgaroth-SG/AsgarothGate/releases/latest/download/${zip_name}"    local temp_zip="/tmp/${zip_name}"    info "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞ —Å ${download_url}..."    if ! curl -sL -o "$temp_zip" "$download_url"; then        error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤ —Ä–µ–ª–∏–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ –≤–∞—à–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."        exit 1    fi    success "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."    info "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."    rm -rf "$HYSTERIA_INSTALL_DIR"    mkdir -p "$HYSTERIA_INSTALL_DIR"    info "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –≤ ${HYSTERIA_INSTALL_DIR}..."    if ! unzip -q "$temp_zip" -d "$HYSTERIA_INSTALL_DIR"; then        error "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤."        exit 1    fi    success "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ."    rm "$temp_zip"    info "–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω."}# ========== –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Geo-–¥–∞–Ω–Ω—ã—Ö (IPv4 + —Ç–∞–π–º–∞—É—Ç—ã + –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞) ==========download_geo_files_ipv4() {    info "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ RU geosite.dat –∏ geoip.dat (IPv4, —Ç–∞–π–º–∞—É—Ç—ã, –∞—Ç–æ–º–∞—Ä–Ω–æ)..."    local wget_opts=(        -4        --timeout=15        --dns-timeout=10        --connect-timeout=10        --read-timeout=15        --tries=3        --waitretry=1        --retry-connrefused    )    # –°–∫–∞—á–∏–≤–∞–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã    wget "${wget_opts[@]}" -O "$HYSTERIA_INSTALL_DIR/geosite.dat.tmp" "$GEOSITE_URL"    wget "${wget_opts[@]}" -O "$HYSTERIA_INSTALL_DIR/geoip.dat.tmp" "$GEOIP_URL"    # –ú–∏–Ω–∏-–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ (–∑–∞—â–∏—Ç–∞ –æ—Ç "HTML/–æ—à–∏–±–∫–∞ –≤–º–µ—Å—Ç–æ dat")    if [[ ! -s "$HYSTERIA_INSTALL_DIR/geosite.dat.tmp" ]] || [[ $(stat -c%s "$HYSTERIA_INSTALL_DIR/geosite.dat.tmp") -lt 1024 ]]; then        error "geosite.dat —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π/–ø—É—Å—Ç–æ–π ‚Äî —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ."        exit 1    fi    if [[ ! -s "$HYSTERIA_INSTALL_DIR/geoip.dat.tmp" ]] || [[ $(stat -c%s "$HYSTERIA_INSTALL_DIR/geoip.dat.tmp") -lt 1024 ]]; then        error "geoip.dat —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π/–ø—É—Å—Ç–æ–π ‚Äî —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ."        exit 1    fi    # –ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–º–µ–Ω—è–µ–º    mv -f "$HYSTERIA_INSTALL_DIR/geosite.dat.tmp" "$HYSTERIA_INSTALL_DIR/geosite.dat"    mv -f "$HYSTERIA_INSTALL_DIR/geoip.dat.tmp" "$HYSTERIA_INSTALL_DIR/geoip.dat"    success "Geo-–¥–∞–Ω–Ω—ã–µ —Å–∫–∞—á–∞–Ω—ã –∏ –∑–∞–º–µ–Ω–µ–Ω—ã."}# ========== –ó–∞—Ö–≤–∞—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ==========declare -a ACTIVE_SERVICES_BEFORE_UPGRADE=()ALL_SERVICES=(    hysteria-caddy.service    hysteria-server.service    hysteria-auth.service    hysteria-scheduler.service    hysteria-telegram-bot.service    hysteria-normal-sub.service    hysteria-caddy-normalsub.service    hysteria-webpanel.service    hysteria-ip-limit.service)info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º..."for SERVICE in "${ALL_SERVICES[@]}"; do    if systemctl is-active --quiet "$SERVICE"; then        ACTIVE_SERVICES_BEFORE_UPGRADE+=("$SERVICE")        info "–°–µ—Ä–≤–∏—Å '$SERVICE' –∞–∫—Ç–∏–≤–µ–Ω –∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω."    fidone# ========== –ü—Ä–æ–≤–µ—Ä–∫–∏/–ø—Ä–µ–¥—É—Å–ª–æ–≤–∏—è ==========check_avx_supportfix_caddy_repoinstall_mongodb# ========== –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ ==========cd /rootTEMP_DIR=$(mktemp -d)FILES=(    "$HYSTERIA_INSTALL_DIR/ca.key"    "$HYSTERIA_INSTALL_DIR/ca.crt"    "$HYSTERIA_INSTALL_DIR/users.json"    "$HYSTERIA_INSTALL_DIR/config.json"    "$HYSTERIA_INSTALL_DIR/.configs.env"    "$HYSTERIA_INSTALL_DIR/nodes.json"    "$HYSTERIA_INSTALL_DIR/extra.json"    "$HYSTERIA_INSTALL_DIR/core/scripts/telegrambot/.env"    "$HYSTERIA_INSTALL_DIR/core/scripts/normalsub/.env"    "$HYSTERIA_INSTALL_DIR/core/scripts/normalsub/Caddyfile.normalsub"    "$HYSTERIA_INSTALL_DIR/core/scripts/webpanel/.env"    "$HYSTERIA_INSTALL_DIR/core/scripts/webpanel/Caddyfile")info "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤: $TEMP_DIR"for FILE in "${FILES[@]}"; do    if [[ -f "$FILE" ]]; then        mkdir -p "$TEMP_DIR/$(dirname "$FILE")"        cp -p "$FILE" "$TEMP_DIR/$FILE"        success "–°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: $FILE"    else        warn "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $FILE"    fidone# ========== –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –∑–∞–º–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ==========download_and_extract_latest_release# ========== –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Geo-–¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ) ==========download_geo_files_ipv4# ========== –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ ==========info "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."for FILE in "${FILES[@]}"; do    BACKUP="$TEMP_DIR/$FILE"    if [[ -f "$BACKUP" ]]; then        cp -p "$BACKUP" "$FILE"        success "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $FILE"    else        warn "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: $BACKUP"    fidone# ========== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ==========info "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Hysteria –¥–ª—è HTTP –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏..."auth_block='{"type": "http", "http": {"url": "http://127.0.0.1:28262/auth"}}'if [[ -f "$HYSTERIA_INSTALL_DIR/config.json" ]]; then    jq --argjson auth_block "$auth_block" '.auth = $auth_block' "$HYSTERIA_INSTALL_DIR/config.json" > "$HYSTERIA_INSTALL_DIR/config.json.tmp" \        && mv "$HYSTERIA_INSTALL_DIR/config.json.tmp" "$HYSTERIA_INSTALL_DIR/config.json"    success "config.json –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏."else    warn "config.json –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ü—Ä–æ–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏."fi# ========== –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ==========info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."if id -u hysteria >/dev/null 2>&1; then    chown hysteria:hysteria "$HYSTERIA_INSTALL_DIR/ca.key" "$HYSTERIA_INSTALL_DIR/ca.crt" 2>/dev/null || true    chmod 640 "$HYSTERIA_INSTALL_DIR/ca.key" "$HYSTERIA_INSTALL_DIR/ca.crt" 2>/dev/null || true    chown -R hysteria:hysteria "$HYSTERIA_INSTALL_DIR/core/scripts/telegrambot" 2>/dev/null || truefichmod +x "$HYSTERIA_INSTALL_DIR/core/scripts/hysteria2/kick.py"chmod +x "$HYSTERIA_INSTALL_DIR/core/scripts/auth/user_auth"success "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã."# ========== –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ ==========info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."cd "$HYSTERIA_INSTALL_DIR"python3 -m venv "$HYSTERIA_VENV_DIR"# shellcheck disable=SC1090source "$HYSTERIA_VENV_DIR/bin/activate"pip install --upgrade pip >/dev/nullpip install -r requirements.txt >/dev/nullsuccess "–°—Ä–µ–¥–∞ Python –≥–æ—Ç–æ–≤–∞."# ========== –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ==========migrate_json_to_mongo# ========== –°–µ—Ä–≤–∏—Å—ã Systemd ==========info "–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ systemd..."# shellcheck disable=SC1090if source "$HYSTERIA_INSTALL_DIR/core/scripts/scheduler.sh"; then    if ! check_auth_server_service; then        setup_hysteria_auth_server && success "–°–µ—Ä–≤–∏—Å —Å–µ—Ä–≤–µ—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω." || warn "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ —É–¥–∞–ª–∞—Å—å."    else        success "–°–µ—Ä–≤–∏—Å —Å–µ—Ä–≤–µ—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."    fi    if ! check_scheduler_service; then        setup_hysteria_scheduler && success "–°–µ—Ä–≤–∏—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω." || warn "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å."    else        success "–°–µ—Ä–≤–∏—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."    fielse    warn "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å scheduler.sh, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."fi# ========== –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ ==========info "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–µ–º–æ–Ω–∞ systemd..."systemctl daemon-reloadinfo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."if [ ${#ACTIVE_SERVICES_BEFORE_UPGRADE[@]} -eq 0 ]; then    warn "–ù–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ü—Ä–æ–ø—É—Å–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞."else    for SERVICE in "${ACTIVE_SERVICES_BEFORE_UPGRADE[@]}"; do        info "–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ $SERVICE..."        systemctl enable "$SERVICE" &>/dev/null || warn "–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å $SERVICE. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."        systemctl restart "$SERVICE"        sleep 2        if systemctl is-active --quiet "$SERVICE"; then            success "$SERVICE —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω."        else            warn "$SERVICE –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–ª–∏ –æ–Ω –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω."            warn "–ü–æ–∫–∞–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∑–∞–ø–∏—Å–µ–π –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è $SERVICE:"            journalctl -u "$SERVICE" -n 5 --no-pager        fi    donefi# ========== –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ==========if systemctl is-active --quiet hysteria-server.service; then    success "üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"else    warn "‚ö†Ô∏è hysteria-server.service –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∂—É—Ä–Ω–∞–ª—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."fi# ========== –ó–∞–ø—É—Å–∫ –º–µ–Ω—é ==========info "–ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω. –ó–∞–ø—É—Å–∫ –º–µ–Ω—é..."cd "$HYSTERIA_INSTALL_DIR"chmod +x menu.sh./menu.sh