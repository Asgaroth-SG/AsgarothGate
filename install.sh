#!/bin/bashRED='\033[0;31m'GREEN='\033[0;32m'YELLOW='\033[0;33m'BLUE='\033[1;94m'NC='\033[0m'BOLD='\033[1m'CHECK_MARK="[‚úì]"CROSS_MARK="[‚úó]"INFO_MARK="[i]"WARNING_MARK="[!]"log_info() {    echo -e "${BLUE}${INFO_MARK} ${1}${NC}"}log_success() {    echo -e "${GREEN}${CHECK_MARK} ${1}${NC}"}log_warning() {    echo -e "${YELLOW}${WARNING_MARK} ${1}${NC}"}log_error() {    echo -e "${RED}${CROSS_MARK} ${1}${NC}" >&2}handle_error() {    log_error "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ $1"    exit 1}trap 'handle_error $LINENO' ERRcheck_root() {    if [ "$(id -u)" -ne 0 ]; then        log_error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ root."        exit 1    fi    log_info "–ó–∞–ø—É—Å–∫ —Å –ø—Ä–∞–≤–∞–º–∏ root"}check_os_version() {    local os_name os_version    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –û–°..."        if [ -f /etc/os-release ]; then        os_name=$(grep '^ID=' /etc/os-release | cut -d= -f2)        os_version=$(grep '^VERSION_ID=' /etc/os-release | cut -d= -f2 | tr -d '"')    else        log_error "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –û–° –∏–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Ä—Å–∏—é –û–°."        exit 1    fi    if ! command -v bc &> /dev/null; then        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ bc..."        apt update -qq && apt install -y -qq bc        if [ $? -ne 0 ]; then            log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç bc."            exit 1        fi    fi    if [[ "$os_name" == "ubuntu" && $(echo "$os_version >= 22" | bc) -eq 1 ]] ||       [[ "$os_name" == "debian" && $(echo "$os_version >= 12" | bc) -eq 1 ]]; then        log_success "–ü—Ä–æ–≤–µ—Ä–∫–∞ –û–° –ø—Ä–æ–π–¥–µ–Ω–∞: $os_name $os_version"    else        log_error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ Ubuntu 22+ –∏–ª–∏ Debian 12+."        exit 1    fi        log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É AVX (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è MongoDB)..."    if grep -q -m1 -o -E 'avx|avx2|avx512' /proc/cpuinfo; then        log_success "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π AVX."    else        log_error "–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π AVX –¥–ª—è MongoDB."        log_info "–î–ª—è —Å–∏—Å—Ç–µ–º –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ AVX –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é –ø–∞–Ω–µ–ª–∏ 'nodb' (–±–µ–∑ –ë–î)."        log_info "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É:"        echo -e "${YELLOW}bash <(curl -sL https://raw.githubusercontent.com/Asgaroth-SG/AsgarothGate/nodb/install.sh)${NC}"        log_error "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞."        exit 1    fi}install_mongodb() {    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ MongoDB..."        if command -v mongod &> /dev/null; then        log_success "MongoDB —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"        return 0    fi        curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor        local codename    codename=$(lsb_release -cs)    local repo_line=""    case "$codename" in        "noble" | "jammy")            repo_line="deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu $codename/mongodb-org/8.0 multiverse"            ;;        "bookworm" | "trixie")            repo_line="deb [ signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] http://repo.mongodb.org/apt/debian bookworm/mongodb-org/8.0 main"            ;;        *)            log_error "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–µ –∫–æ–¥–æ–≤–æ–µ –∏–º—è –û–° –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ MongoDB: $codename"            exit 1            ;;    esac    echo "$repo_line" | tee /etc/apt/sources.list.d/mongodb-org-8.0.list > /dev/null        apt update -qq    apt install -y -qq mongodb-org        systemctl enable mongod    systemctl start mongod        if systemctl is-active --quiet mongod; then        log_success "MongoDB —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞"    else        log_error "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ MongoDB –∏–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"        exit 1    fi}install_packages() {    local REQUIRED_PACKAGES=("jq" "curl" "pwgen" "python3" "python3-pip" "python3-venv" "bc" "zip" "unzip" "lsof" "gnupg" "lsb-release")    local MISSING_PACKAGES=()        log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."        for package in "${REQUIRED_PACKAGES[@]}"; do        if ! command -v "$package" &> /dev/null && ! dpkg -l | grep -q "^ii.*$package "; then            MISSING_PACKAGES+=("$package")        else            log_success "–ü–∞–∫–µ—Ç $package —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"        fi    done    if [ ${#MISSING_PACKAGES[@]} -ne 0 ]; then        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤: ${MISSING_PACKAGES[*]}"        apt update -qq || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ apt"; exit 1; }        apt upgrade -y -qq || { log_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."; }                for package in "${MISSING_PACKAGES[@]}"; do            log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ $package..."            if apt install -y -qq "$package"; then                log_success "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω $package"            else                log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å $package"                exit 1            fi        done    else        log_success "–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."    fi        install_mongodb}download_and_extract_release() {    log_info "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø–∞–Ω–µ–ª–∏ Asgaroth Gate..."    if [ -d "/etc/hysteria" ]; then        log_warning "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /etc/hysteria —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."        read -p "–í—ã —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ—ë –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ? (y/n): " -n 1 -r        echo        if [[ $REPLY =~ ^[Yy]$ ]]; then            rm -rf /etc/hysteria        else            log_info "–ü—Ä–æ–ø—É—Å–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è."            return 0        fi    fi    local arch    case $(uname -m) in        x86_64) arch="amd64" ;;        aarch64) arch="arm64" ;;        *)            log_error "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $(uname -m)"            exit 1            ;;    esac    log_info "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $arch"    local zip_name="AsgarothGate-${arch}.zip"    local download_url="https://github.com/Asgaroth-SG/AsgarothGate/releases/latest/download/${zip_name}"    local temp_zip="/tmp/${zip_name}"    log_info "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å ${download_url}..."    if curl -sL -o "$temp_zip" "$download_url"; then        log_success "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."    else        log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ä–µ–ª–∏–∑. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ –≤–∞—à–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."        exit 1    fi    log_info "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –≤ /etc/hysteria..."    mkdir -p /etc/hysteria    if unzip -q "$temp_zip" -d /etc/hysteria; then        log_success "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ."    else        log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤."        exit 1    fi        rm "$temp_zip"    log_info "–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω."        local auth_binary="/etc/hysteria/core/scripts/auth/user_auth"    if [ -f "$auth_binary" ]; then        chmod +x "$auth_binary"        log_success "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ auth."    else        log_warning "–ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª auth –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $auth_binary. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω–æ–π."    fi}setup_python_env() {    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è Python..."        cd /etc/hysteria || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /etc/hysteria"; exit 1; }        if python3 -m venv hysteria2_venv &> /dev/null; then        log_success "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python —Å–æ–∑–¥–∞–Ω–æ"    else        log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python"        exit 1    fi        source /etc/hysteria/hysteria2_venv/bin/activate || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ"; exit 1; }        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python..."    if pip install -r requirements.txt &> /dev/null; then        log_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"    else        log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python"        exit 1    fi}add_alias() {    log_info "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª–∏–∞—Å–∞ 'hys2' –≤ .bashrc..."        if ! grep -q "alias hys2='source /etc/hysteria/hysteria2_venv/bin/activate && /etc/hysteria/menu.sh'" ~/.bashrc; then        echo "alias hys2='source /etc/hysteria/hysteria2_venv/bin/activate && /etc/hysteria/menu.sh'" >> ~/.bashrc        log_success "–ê–ª–∏–∞—Å 'hys2' –¥–æ–±–∞–≤–ª–µ–Ω –≤ .bashrc"    else        log_info "–ê–ª–∏–∞—Å 'hys2' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ .bashrc"    fi}setup_main_node_label() {    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–æ–¥—ã..."    echo    read -p "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'üá∫üá∏ –°–®–ê') [–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è]: " main_node_label    if [ -z "$main_node_label" ]; then        main_node_label="üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è"    fi    mkdir -p /etc/hysteria    if [ -f /etc/hysteria/.configs.env ]; then        grep -v '^MAIN_NODE_LABEL=' /etc/hysteria/.configs.env > /etc/hysteria/.configs.env.tmp || true        mv /etc/hysteria/.configs.env.tmp /etc/hysteria/.configs.env    fi    echo "MAIN_NODE_LABEL=$main_node_label" >> /etc/hysteria/.configs.env    log_success "–ì–ª–∞–≤–Ω–∞—è –Ω–æ–¥–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫: $main_node_label"}run_menu() {    log_info "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–ø—É—Å–∫—É –º–µ–Ω—é..."        cd /etc/hysteria || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /etc/hysteria"; exit 1; }    chmod +x menu.sh || { log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å menu.sh –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º"; exit 1; }        log_info "–ó–∞–ø—É—Å–∫ –º–µ–Ω—é..."    echo -e "\n${BOLD}${GREEN}======== –ó–∞–ø—É—Å–∫ –º–µ–Ω—é Asgaroth Gate ========${NC}\n"    ./menu.sh}main() {    echo -e "\n${BOLD}${BLUE}======== –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Asgaroth Gate ========${NC}\n"        check_root    check_os_version    install_packages    download_and_extract_release    setup_python_env    add_alias    setup_main_node_label        source ~/.bashrc &> /dev/null || true        echo -e "\n${YELLOW}–ó–∞–ø—É—Å–∫ Asgaroth Gate —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...${NC}"    sleep 3        run_menu}main